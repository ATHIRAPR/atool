<?php
require_once ("include/init.php.inc");
require_once ("include/smarty.php.inc");
require_once ("include/db.php.inc");
require_once ("include/auth.php.inc");
require_once ("include/util.php.inc");
// 選択された左メニュー項目
$smarty->assign ( "func_info", array (
    "publish" => 1 
) );
// 公開管理権限が無い場合は、エラーにする
if ($role_info ['publish_role_flg'] != 1) {
    // エラーメッセージ表示
    show_error_page ( array (
        "公開管理者の権限がありません" 
    ), "manage.php", "トップページへ戻る" );
    exit ();
}
if ($_SERVER ['REQUEST_METHOD'] === 'POST') {
    $clinic_id = $_POST ['clinic_id'];
    $doctype_id = $_POST ['doctype_id'];
    $title = mb_convert_encoding ( $_POST ['title'], "UTF-8", $OUTPUT_ENCODING );
    $file_nm = mb_convert_encoding ( $_POST ['file_nm'], "UTF-8", $OUTPUT_ENCODING );
    $show_sync_target_only = $_POST ['show_sync_target_only'];
    $smarty->assign ( "clinic_id", $clinic_id );
    $smarty->assign ( "doctype_id", $doctype_id );
    $smarty->assign ( "title", $title );
    $smarty->assign ( "file_nm", $file_nm );
} else if ($_SERVER ['REQUEST_METHOD'] === 'GET') {
    $show_sync_target_only = 1;
}
if (! isset ( $show_sync_target_only )) {
    $show_sync_target_only = 0;
}
$smarty->assign ( "show_sync_target_only", $show_sync_target_only );
$cmm = new ClinicMasterManager ();
$clinic_all = $cmm->get_all ();
$clinic_options ['0'] = "全て";
foreach ( $clinic_all as $clinic ) {
    $clinic_options [$clinic ['id']] = $clinic ['clinic_nm'];
}
$smarty->assign ( "clinic_options", $clinic_options );
$dmm = new DoctypeMasterManager ();
$doctype_all = $dmm->get_all ();
$doctype_options ['0'] = "全て";
foreach ( $doctype_all as $doctype ) {
    $doctype_options [$doctype ['id']] = $doctype ['type_nm'];
}
$doctype_options ['99'] = "その他";
$smarty->assign ( "doctype_options", $doctype_options );
$uim = new UserInfoManager ();
$result_ary = search_publish_info ( $file_id, $doctype_id, $clinic_id, $title, $file_nm, $show_sync_target_only );
foreach ( $result_ary as &$result ) {
    $result ['type_nm'] = $doctype_options [$result ['doctype_id']];
    // 変更内容文字列取得
    $modified = get_modified_text ( $result );
    // 変更内容をセット
    $result ['modified'] = $modified;
    // 更新ユーザ情報を取得
    $update_user_info = $uim->get ( $result ['update_user_id'] );
    $result ['update_email_name'] = strstr ( $update_user_info ['email'], "@", TRUE );
}
$smarty->assign ( 'list', $result_ary );
show_template_page ( "manage_publish.tpl.html" );
exit ();
// 変更内容の表示文字列を返す
function get_modified_text($result) {
    // 変更内容の情報を付加する
    $file_modified_array = array ();
    $modified = "";
    // 更新フラグがONの場合、変更内容を表示する
    if (! is_null ( $result ['edit_update_dt'] )) {
        // ファイルのアップロード更新済み(ファイル名がセットされている)
        if ($result ['edit_file_nm']) {
            $file_modified_array [] = "ファイル";
        }
        // ダウンロードファイル変更済み
        if ($result ['edit_download_file_nm'] && ($result ['edit_download_file_nm'] != $result ['file_download_file_nm'])) {
            $file_modified_array [] = 'DLファイル名';
        }
        // PDFパスワード変更済み
        if ($result ['edit_pdf_password'] && ($result ['edit_pdf_password'] !== $result ['file_pdf_password'])) {
            $file_modified_array [] = 'PDFパスワード';
        }
        // カテゴリ変更済み
        if ($result ['edit_clinic_flg_ary'] && ($result ['edit_clinic_flg_ary'] !== $result ['file_clinic_flg_ary'])) {
            $file_modified_array [] = 'カテゴリ';
        }
        // 文書種別変更済み
        if ($result ['edit_doctype_id'] && ($result ['edit_doctype_id'] !== $result ['file_doctype_id'])) {
            $file_modified_array [] = '文書種別';
        }
        // 公開日変更済み
        if ($result ['edit_publish_start_dt'] && ($result ['edit_publish_start_dt'] !== $result ['file_publish_start_dt'])) {
            $file_modified_array [] = '公開日';
        }
        // 更新日変更済み
        if ($result ['edit_download_update_dt'] && ($result ['edit_download_update_dt'] !== $result ['file_download_update_dt'])) {
            $file_modified_array [] = '更新日';
        }
    }
    // 変更内容の表示
    if (0 < count ( $file_modified_array )) {
        $modified .= join ( '/', $file_modified_array );
    }
    return $modified;
}
?>
