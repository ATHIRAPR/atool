<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<!-- Meta -->
{include file="page_meta.tpl.html"}
<!-- /Meta -->
<link rel="stylesheet" type="text/css" href="css/default.css" media="screen,print" />
<title>文書ファイル管理ツール</title>

<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="js/clinic_checkbox.js"></script>

<link rel="stylesheet" href="css/validationEngine.jquery.css" type="text/css"/>
<script src="js/languages/jquery.validationEngine-ja.js" type="text/javascript" charset="utf-8"></script>
<script src="js/jquery.validationEngine.js" type="text/javascript" charset="utf-8"></script>
<!--
<script type="text/javascript" src="js/jquery.filestyle.js" ></script>
-->
<script type="text/javascript" src="js/jquery-ui.min.js"></script>
<link type="text/css" rel="stylesheet" href="css/jquery-ui.css" />

<script language="javascript">
	{if $url_path_flg}
	var path_flg = true;
	{else}
	var path_flg = false;
	{/if}

	function search_product() {
		var form = document.edit_file_form;
		//var options = "dialogWidth=940px;dialogHeight=800px;center=1;status=1;scroll=1;resizable=1;minimize=0;maximize=0;menubar=1;";
		var options = "width=800,height=600,resizable=yes,scrollbars=yes";//"dialogWidth=940px;dialogHeight=800px;";
		var url = "manage_product.php?product_nm=" + encodeURI(form.product_nm.value);
		//window.showModalDialog(url, window, options);
		window.open(url, "_blank", options);
		//window.showModalDialog(url, form.product_nm.value, options);
	}
</script>

<script language="javascript">
	$(function() {
		jQuery("#edit_file_form").validationEngine('attach', {
 			 onValidationComplete: function(form, status){
				if (status) {
					return confirm("ファイルを変更します");
				}
			  }
		});

/*
		//$("#add_file_form").validation();
		$("#edit_file_form").exValidation({
		    errInsertPos: 'after',
		    errPosition: 'fixed',
		    stepValidation: true,
		    customListener: "",

		    customAddError: function() {
	        //if ( $("#alert").length<1 ) {
	          //$("p.attention").before("<div id=\"alert\"><strong>入力内容に誤りがあります。</strong></div>");
		          alert("入力内容に不備があります");
	        //}
			},

			customClearError: function() {
				return confirm('ファイルを変更します');
			},

			stepValidation: true
		});


		$("input[type=file]").filestyle({
		     image: "image/btn_refer.jpg",
		     imageheight : 20,
		     imagewidth : 58,
		     width : 250
		 });
*/

//		$("input#pdf_file_0").removeAttr("disabled");
//		$("table#add_pdf_file_0").show();//removeAttr("disabled").show();

	});

//--datepicker制御
$(function(){
	$(".datepicker").datepicker({
		changeMonth: true,
		changeYear: true,
		showOn: "focus",
		dateFormat: "yy/mm/dd",
		showAnim: "slideDown",
		beforeShow: function(){
			$('#ui-datepicker-div').css('font-size', '80%');
		}
	});
});

$(function () {
    $( 'input[name="status_flg"]:radio' ).change( function() {  
        if (($( this ).val() == "0") && path_flg) {
            if (!confirm("リンク元ファイルが存在します" )){
            	$( 'input[name="status_flg"]:radio' ).val(["1"]);
            }
        }    
    });  
 });
</script>

<script>
function change_file_count() {
	var cnt = $("#file_count").val();
	var now = $("table.add_file_table:visible").length;

	if(cnt == "") {
		//全部非表示にする
		$("table.add_file_table").css("display", "none");
		$("input[type=file]:hidden").attr("disabled", "disabled");

	} else if (now < cnt) {
		//非表示から表示に変える
		$("table.add_file_table").slice(0, cnt).show();
		$("input[type=file]:visible").removeAttr("disabled");

	} else if (cnt < now) {
		//表示から非表示にする
		$("table.add_file_table").slice(cnt, 10).css("display", "none");
		$("input[type=file]:hidden").attr("disabled", "disabled");
	}
}
</script>

<script>
function copy_to_add_file() {
	document.edit_file_form.file_op.value = "file_copy";
	document.edit_file_form.action = "add_file.php";
	document.edit_file_form.submit();
}

function delete_check(){
	if (path_flg) {
		if (!confirm("リンク元ファイルが存在します" )){
			return;
		}
	}
	if(confirm('ファイル削除を行います')){
		document.edit_file_form.submit();
	}
}
</script>
</head>

<body onload="change_file_count();">

<div id="skip_link_block">
	<ul>
		<li><a href="#main_content_anc">本文へジャンプします</a></li>

	</ul>
	<p id="pageTop">ページの先頭です</p>
</div>

<div id="contents">

<!-- Header Area -->
{include file="page_header.tpl.html"}
<!-- /Header Area -->

<!-- Contents Area -->

<div id="contents_body" class="clearfix">

	<div id="skip_menu_block">
		<p id="side_navi_anc"><a name="side_navi_anc">メニューの始まりです</a></p>
	</div>

	<!-- Left Navi Area -->
	{include file="left_menu.tpl.html" role_info=$role_info func_info=$func_info}
	<!-- /Left Navi Area -->

	<!-- Main Contents Area -->
	<div id="main_content_area">

		<div id="skip_main_block">
			<p id="main_content_anc"><a name="main_content_anc">本文の始まりです</a></p>
		</div>

		<h2><em>ファイル編集</em></h2>

		<form name="edit_file_form" method="post" enctype="multipart/form-data" id="edit_file_form">

		<p class="text">
			{foreach from=$msg_array item=msg}
			<span class="text_red text_wb">{$msg}</span><br>
			{/foreach}
		</p>

		<p>
			<span>最大10個までファイルを追加できます</span>
			<!--<input type="button" value="ファイル追加" onclick="show_add_pdf();"> -->
			<select id="file_count" name="file_count" onchange="change_file_count();">
			<option value="">なし</option>
			{for $i=1 to 10-count($detail_array)}
				<option value="{$i}" {if $i == (count($new_detail_array))}selected{/if}>{$i}</option>
			{/for}
			</select>
		</p>

		<p>
			<span class="text_red">(*:必須)</span>
		</p>

		<!-- 登録情報入力 -->
		<div class="task_input_form">
			<table>
				<tr>
					<td>
						<span class="text_red text_s">※登録ファイル名と差し替えファイル名には、全角文字を含まないでください。</span><br>
						<span class="text_red text_s">※ダウンロードファイル名には、100文字まで使用できます。</span><br>
						<span class="text_red text_s" style="margin-left: 1em;">ダウンロードファイル名には、拡張子まで入力してください。 　例：洗浄消毒装置.pdf</span><br>
						<span class="text_red text_s" style="margin-left: 1em;">ダウンロードファイル名が入力されなかった場合は、登録ファイル名と同じファイル名で登録されます。</span>
					</td>
				</tr>
			</table>

			{for $cnt=0 to 10-count($new_detail_array)}
			{assign var=new_detail value=$new_detail_array[$cnt]}
			<table id="add_pdf_file_{$cnt}" style="border: double 3px #adadad; padding: 5px; margin-bottom: 5px; display: none;" class="add_file_table">
			<tr>
				<td>
					<div>登録ファイル{$cnt+1}<span class="text_red">*</span></div>
				</td>
				<td>
					<input type="file" id="pdf_file_{$cnt}" name="new_pdf_file[]" size="50" class="validate[required,checkFileType[pdf|PDF|zip|ZIP]]" disabled="disabled" data-prompt-position="bottomRight"></input>
				</td>
			</tr>
<!--
			<tr>
				<td></td><td><span class="text_red text_s">※登録ファイル名には全角文字を含まないでください。</span></td>
			</tr>
-->
			<tr>
				<td>
					<div>ダウンロードファイル名</div>
				</td>
				<td>
					<input type="text" name="new_download_filename[]" value="{$new_detail.download_file_nm|escape}" size="25" maxlength="100"></input>
				</td>
			</tr>

			<tr>
				<td>
					<div>版番号</div>
				</td>
				<td>
					<input type="text" name="new_download_version[]" value="{$new_detail.version|escape}" size="25" maxlength="50"></input>
				</td>
			</tr>
			<tr>
				<td>
					<div>更新日時</div>
				</td>
				<td>
					<input type="text" name="new_download_update_dt[]" value="{$new_detail.version_update|escape}" size="25" maxlength="50" class="datepicker"></input>
				</td>
			</tr>
			<tr>
				<td>
					<div>PDFパスワード</div>
				</td>
				<td>
					<input type="text" name="new_pdf_password[]" value="{$new_detail.pdf_password|escape}" size="25" maxlength="50"></input>
				</td>
			</tr>
			</table>
			{/for}

			{assign var=i value=1}
			{foreach from=$detail_array item=detail}
			{if not $detail.delete_flg}
			<table style="border: double 3px #adadfd; padding: 5px; margin-bottom: 5px;">
			<tr>
				<td><div>現在の登録ファイル{$i}</div></td>

				<td><div style="float:left;">{$detail.file_nm|escape} ({$detail.filesize|escape})</div>
				{if 1 < count($detail_array)}
				<div align="right"><label><input type="checkbox" name="delete_detail_id[]" value="{$detail.id}"></input> 登録ファイル{$i}を削除</label></div>
				{/if}
				</td>
			</tr>
			<tr>
				<td><div>公開URL</div></td>
				<td>/search/medicaltown.php?id={$detail.url_hash|escape}</td>
			</tr>

			<tr>
				<td>
					<div>差し替えファイル</div>
				</td>
				<td>
					<input type="file" id="pdf_file{$i++}" name="pdf_file[]" size="50" class="validate[checkFileType{if $detail.file_nm|regex_replace:'/\.pdf$/i':'test' ne $detail.file_nm}[pdf|PDF]{elseif $detail.file_nm|regex_replace:'/\.zip$/i':'test' ne $detail.file_nm}[zip|ZIP]{else}[pdf|PDF|zip|ZIP]{/if}]"></input>
					<input type="hidden" name="detail_id[]" value="{$detail.id}"></input>
				</td>
			</tr>
<!--
			<tr>
				<td></td><td><span class="text_red text_s">※差替えファイル名には全角文字を含まないでください。</span></td>
			</tr>
 -->
			<tr>
				<td>
					<div>ダウンロードファイル名</div>
				</td>
				<td>
				<!--
					<input type="text" name="pdf_password" value="{$detail.download_file_nm|escape}" size="25" maxlength="50"></input>
				-->
					<input type="text" name="download_filename[]" value="{$detail.download_file_nm|escape}" size="25" maxlength="100"></input>
				</td>
			</tr>

			<tr>
				<td>
					<div>版番号</div>
				</td>
				<td>
					<input type="text" name="download_version[]" value="{$detail.version|escape}" size="25" maxlength="50"></input>
				</td>
			</tr>
			<tr>
				<td>
					<div>更新日時</div>
				</td>
				<td>
					<input type="text" name="download_update_dt[]" value="{$detail.version_update|escape}" size="25" maxlength="50" class="datepicker"></input>
				</td>
			</tr>

			<tr>
				<td>
					<div>PDFパスワード</div>
				</td>
				<td>
					<!--<input type="text" name="pdf_password" value="{$detail.pdf_password}" size="25"></input> -->
					<input type="text" name="pdf_password[]" value="{$detail.pdf_password|escape}" size="25" maxlength="50"></input>
				</td>
			</tr>

			<tr>
				<td><div>リンク元URL</div></td>
				<td>
				{foreach from=$detail.url_path item=url_path}
				{if $url_path.url_path|strstr: "http"}
				<a href="{$url_path.url_path|escape}" target="_blank">
				{/if}
				{$url_path.url_path|escape}<br/>
				{if $url_path.url_path|strstr: "http"}
				</a>
				{/if}
				{/foreach}
				</td>
			</tr>

<!--
			<tr>
				<td></td>
				<td>
					<span class="text_red text_s">※使用可能文字：半角英数字、"-"(ハイフン)、"_"(アンダーバー)</span><br>
					<span class="text_red text_s">※文字数：128</span><br>
					<span class="text_red text_s">※全角文字は含まないでください。<br>
					<span class="text_red text_s">※ダウンロードファイル名を指定しなかった場合、アップロードファイルと同じ名前になります。</span>
				</td>
			</tr>

			<tr>
				<td><div>現在の登録ファイル名</div></td>
				<td>{$detail.file_nm|escape}</td>
			</tr>
			<tr>
				<td><div>ファイルサイズ</div></td>
				<td>{$detail.filesize|escape}</td>
			</tr>
-->
			</table>
			{/if}
			{/foreach}

			<table>
			<tr>
				<td>
					<div>名称<span class="text_red">*</span></div>
				</td>
				<td>
					<input type="text" id="product_nm" name="product_nm" value="{$data.product_nm|escape}" size="50" class="validate[required,checkProductName]" maxlength="1000" style="width: 250px;" data-prompt-position="bottomRight"></input>
					<!--<input type="image" class="search_position" alt="検索" src="image/btn_product.jpg" onclick="javascript:search_product(); return false;"></input>-->
					<input type="button" value="名称選択" class="search_position" alt="名称選択" onclick="javascript:search_product(); return false;"></input>
				</td>
			</tr>
			<tr>
				<td></td>
				<td>
					<span class="text_red text_s">※名称には1,000文字まで使用できます。</span>
				</td>
			</tr>
			<tr>
				<td>
					<div>型番</div>
				</td>
				<td>
					<textarea name="model_nm" cols="45" rows="5" class="chkmax5000">{$data.model_nm|escape}</textarea>
					<!-- <textarea name="model_nm" cols="45">{$model_nm}</textarea> -->
					{*html_checkboxes name="model_visible_flg" options=$model_visible_options selected=$data.model_visible_flg*}
					<label for="model_visible_flg"><input id="model_visible_flg" type="checkbox" class="check_position" name="model_visible_flg" value="1"  {if $data.model_visible_flg == 1}checked{/if}></input>型番を非表示にする</label>
				</td>
			</tr>

			<tr>
				<td></td>
				<td>
					<span class="text_red text_s">※型番には半角5,000文字、全角2,500文字まで使用できます。</span><br>
					<span class="text_red text_s">※複数の型番を入力するときは、改行で区切ってください。</span><br>
					<span class="text_red text_s">※スコープなど「TYPE」が入るものは「-（半角ハイフン）」に統一してください。　例：LTF TYPE VPではなくてLTF-VPとする</span>
				</td>
			</tr>

			<tr>
				<td>
					<div>文書種別<span class="text_red">*</span></div>
				</td>
				<td>
					<select name="doctype_id">
					{html_options options=$doctype_options selected=$data.doctype_id}
					</select>
				</td>
			</tr>

			<tr>
				<td>
					<div>診療科<span class="text_red">*</span></div>
				</td>
				<td>
					<div id="clinic_checkboxes_part"  class="chkcheckbox" style="font-size:100%;">
					{foreach from=$clinic_options item=clinic_name key=value name='clinic'}
						<label for="clinic_{$value}"><input id="clinic_{$value}" type="checkbox" value="{$value}" name="clinic_id_array[]" class="validate[required,checkClinicCheck] checkbox" data-prompt-position="bottomRight" {if $value|in_array:$data.clinic_id_array}checked{/if}></input>{$clinic_name}</label>
						{if ($smarty.foreach.clinic.index+1) % 5 == 0}<br/>{/if}
					{/foreach}


					{*html_checkboxes name='clinic_id_array' options=$clinic_options selected=$data.clinic_id_array assign=clinic_checkboxes_tags}
					{foreach from=$clinic_checkboxes_tags item=checkbox_tag name='clinic'}
						{$checkbox_tag}
						{if ($smarty.foreach.clinic.index+1) % 5 == 0}<br/>	{/if}
					{/foreach*}
					</div>
				</td>
			</tr>

			<tr>
				<td><div>フリーキーワード</div></td>
				<td><textarea name="search_keyword" cols="45" rows="5">{$data.search_keyword}</textarea></td>
			</tr>
			<tr>
				<td></td><td><span class="text_red text_s">※フリーキーワードには2,000文字まで使用できます。</span><br>
					<span class="text_red text_s">※複数のキーワードを入力するときは、改行で区切ってください。</span></td>
			</tr>

			<tr>
				<td><div>公開の状態</div></td>
				<!--
				<td>{if $publish_info.status_flg == 1 || $publish_info.status_flg == 2}公開中{else}非公開{/if} {$publish_info.publish_url|escape}</td>
				-->
				<td>
				{if $data.status_flg == 1}
		        	{if $data.publish_start_dt|strtotime < $smarty.now}
			        公開
	     	    	{else}
			        公開予定
			        {/if}
			    {else}
			    	{if $data.publish_dt}非公開{else}新規{/if}
			    {/if}
				</td>
			</tr>

			<tr>
				<td><div>公開設定</div></td>
				<td>
					<label for="publish_on"><input type="radio" id="publish_on" name="status_flg" value="1" {if $data.edit_status_flg == 1}checked{/if}>公開</label>
					<label for="publish_off"><input type="radio" id="publish_off" name="status_flg" value="0" {if $data.edit_status_flg == 0}checked{/if}>非公開</label>
				</td>
			</tr>

			<tr>
				<td>
					<div>掲載開始日</div>
				</td>
				<td>
					<input type="text" name="publish_start_dt" value="{$data.publish_start_dt|escape|date_format:'%Y/%m/%d'}" size="25" maxlength="50" class="datepicker"></input>
				</td>
			</tr>

			<tr>
				<td>
					<div>販売終了日</div>
				</td>
				<td>
					<input type="text" name="sale_end_dt" value="{$data.sale_end_dt|escape|date_format:'%Y/%m/%d'}" size="25" maxlength="50" class="datepicker"></input>
				</td>
			</tr>

			<tr>
				<td><div>更新日</div></td>
				<td>{$update_dt|escape|date_format:"%Y/%m/%d %H:%M:%S"}</td>
			</tr>
			<tr>
				<td><div>登録者</div></td>
				<td>{$update_user_info.login_nm|escape}</td>
			</tr>
			<tr>
				<td><div>初回反映日</div></td>
				<td>{$data.publish_dt|escape|date_format:"%Y/%m/%d %H:%M:%S"}</td>
			</tr>
			<tr>
				<td><div>初回反映者</div></td>
				<td>{$publish_user_info.login_nm|escape}</td>
			</tr>

			</table>

			<p style="overflow:hidden" class="center">
	
			{if $data.status_flg == 0}
			<span style="float:right">
			<input type="image" alt="ファイルを削除する" src="image/btn_delete2.jpg" name="delete_file_submit" onclick="document.edit_file_form.file_op.value='delete'; delete_check();　; return false;"></input></span>
			{/if}

			<input type="image" alt="変更する" src="image/btn_change.jpg" name="edit_file_submit" onclick="document.edit_file_form.file_op.value='edit'; return true;" />

			<input type="image" alt="キャンセル" src="image/btn_cancel.jpg" onclick="window.location.href='manage_file.php'; return false;">

			<input type="image" alt="コピー" src="image/btn_copy.jpg" name="edit_file_submit" onclick="copy_to_add_file(); return false;" />
			</p>

			<input type="hidden" name="id" value="{$data.id}"></input>
			<input type="hidden" name="file_op" value=""></input>

		</div>
		</form>

	</div>
	<!-- /Main Contents Area -->

</div>
<!-- /Contents Area -->


<!-- Footer Area -->
{include file="page_footer.tpl.html"}
<!-- /Footer Area -->

</div>
</body>
</html>


